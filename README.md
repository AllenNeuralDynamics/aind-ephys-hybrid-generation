# Generate hybrid recordings for spike sorting evaluation
## aind-ephys-hybrid-generation

Generate hybrid datasets from existing recordings, by injecting known ground truth into the data.

## Description

This capsule generates hybrid ground-truth datasets by combining existing recordings with hybrid ground-truth spikes. The hybrid templates are 
from the [SpikeInterface hybrid template database](https://github.com/SpikeInterface/hybrid_template_library).

## Inputs

The `data/` folder must include the session data and at least one JSON file generated by the [aind-ephys-job-dispatch](https://github.com/AllenNeuralDynamics/aind-ephys-job-dispatch) capsule is required (1 is recommended). 


### Parameters

### Parameters

The `code/run` script takes the following arguments:


```bash
  --min-amp MIN_AMP     Minimum amplitude to scale injected templates
  --max-amp MAX_AMP     Maximum amplitude to scale injected templates
  --min-depth-percentile MIN_DEPTH_PERCENTILE
                        Percentile of depths used as minimum depth
  --max-depth-percentile MAX_DEPTH_PERCENTILE
                        Percentile of depths used as maximum depth
  --num-units NUM_UNITS
                        Number of hybrid units for each case
  --num-cases NUM_CASES
                        Number of cases for each recording
  --skip-correct-motion
                        Whether to skip motion correction.

```

### Output

The output of this capsule includes two subfolders: `recordings` and `flattened`.

The `recordings` folder contains the hybrid recording files, saved as `job_{recording_name}_{case_name}.pkl`. These can be used to parallelize downstream processes.

The `flattened` folder contains the following:

- `flattened/analyzer_{recording_name}_{case_name}` folder, with the pre-computed `SortingAnalyzer` for the hybrid dataset for each case and recording
- `flattened/motion_{recording_name}` folder, containing the motion estimation data (if motion estimation is not skipped)
- `flattened/gt_{recording_name}_{case_name}.pkl` file, containing the PKL file to reload the ground-truth sorting
- `flattened/job_{recording_name}_{case_name}.pkl` file, containing the PKL file to reload the hybrid recording

In addition it includes some figures:
- `flattened/fig-rasters_{recording_name}_{case_name}.png`: a raster map with overlayed ground-truth spikes and motion
- `flattened/fig-motion_{recording_name}.png`: the output of the `spikeinterface.widgets.plot_motion` function with the estimated motion and corrected peaks.





1.0.0## Version- Runtime: Varies based on recording size, typically 1-4 hours per recording- CPU: 8+ cores recommended- RAM: 32GB minimum recommended